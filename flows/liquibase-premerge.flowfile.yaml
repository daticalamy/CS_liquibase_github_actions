globalVariables:
  # value after :- is the default value
  TAG: ${LB_TAG}
  
stages:

  # Validate changes
  Validation:
    actions: 
      - type: liquibase
        command: validate

  Status:
    actions:
      - type: liquibase
        command: status
        cmdArgs: {verbose: true}

#      - type: control
#        if: "status.changesetCount == 0"
#        command: exit
#        cmdArgs: {exitCode: 0, exitMessage: "Exiting with an error status of 0 because the database is up-to-date"}

#  Checks-Changelog:
#    actions:
#      - type: liquibase
#        command: checks run
#        cmdArgs: {checks-scope: changelog, changeset-filter: "PENDING"}
#        globalArgs: { reports-name: "checks-report-premerge-changelog.html"}        
        
  # Deploy to ephemeral database
  Deploy-to-EphemeralDB:
    actions:
      - type: liquibase
        command: flow
        cmdArgs: {flowFile: "clone-sqlserver.yaml"}
      
      #Update SQL
      # - type: liquibase
        # command: updateSQL
        # cmdArgs: { URL: "${CLONED_URL}", USERNAME: "${CLONED_UID}", PASSWORD: "${CLONED_PW}", labels: "${Labels}" }
        
      #Tag the database 
      # - type: liquibase
        # command: tag
        # cmdArgs: { tag: "${TAG}", URL: "${CLONED_URL}", USERNAME: "${CLONED_UID}", PASSWORD: "${CLONED_PW}" }

      #Run the update (with testing rollback)
      # - type: liquibase
        # command: update-testing-rollback
        # cmdArgs: { URL: "${CLONED_URL}", USERNAME: "${CLONED_UID}", PASSWORD: "${CLONED_PW}", reports-name: "clone-report.html" }       
        
endStage:
  actions:
    - type: liquibase
      command: history
      
    # - type: shell
      # command: sqlcmd -S localhost -U ${CLONED_UID} -P ${CLONED_PW} -v DBNAME=${DATABASENAME} -i clonedbcleanup.sql
      
    # - type: shell
      # command: del "C:\Program Files\Microsoft SQL Server\MSSQL16.MSSQLSERVER22\MSSQL\Backup\%DATABASENAME%.bak"